# Nom du projet GCP existant
PROJECT_ID=keskia

# Buckets dÃ©jÃ  crÃ©Ã©s
DATA_BUCKET=parcoursur-data
MODELS_BUCKET=parcoursur-models
SERVICE_ACCOUNT_NAME=parcoursur-sa
SERVICE_ACCOUNT_EMAIL=$(SERVICE_ACCOUNT_NAME)@$(PROJECT_ID).iam.gserviceaccount.com
SERVICE_ACCOUNT_KEY=parcoursur-sa-key.json

# ğŸ“Œ CrÃ©er le Service Account
create-service-account:
	@echo "ğŸ”¹ CrÃ©ation du Service Account: $(SERVICE_ACCOUNT_NAME)"
	gcloud iam service-accounts create $(SERVICE_ACCOUNT_NAME) \
		--description="Service Account pour gÃ©rer $(PROJECT_ID)" \
		--display-name="parcoursur-service-account"

# ğŸ“Œ Ajouter les rÃ´les nÃ©cessaires
assign-roles:
	@echo "ğŸ”¹ Attribution des rÃ´les au Service Account..."
	gcloud projects add-iam-policy-binding $(PROJECT_ID) \
		--member="serviceAccount:$(SERVICE_ACCOUNT_EMAIL)" \
		--role="roles/editor"
	gcloud projects add-iam-policy-binding $(PROJECT_ID) \
		--member="serviceAccount:$(SERVICE_ACCOUNT_EMAIL)" \
		--role="roles/storage.admin"
	gcloud projects add-iam-policy-binding $(PROJECT_ID) \
		--member="serviceAccount:$(SERVICE_ACCOUNT_EMAIL)" \
		--role="roles/logging.admin"

# ğŸ“Œ GÃ©nÃ©rer une clÃ© JSON pour lâ€™authentification
generate-key:
	@echo "ğŸ”¹ GÃ©nÃ©ration de la clÃ© JSON pour $(SERVICE_ACCOUNT_NAME)..."
	gcloud iam service-accounts keys create $(SERVICE_ACCOUNT_KEY) \
		--iam-account=$(SERVICE_ACCOUNT_EMAIL)

# ğŸ“Œ Configurer lâ€™authentification avec le Service Account
auth-service-account:
	@echo "ğŸ”¹ Authentification avec le Service Account..."
	export GOOGLE_APPLICATION_CREDENTIALS=$(SERVICE_ACCOUNT_KEY)
	gcloud auth activate-service-account --key-file=$(SERVICE_ACCOUNT_KEY)

# ğŸ“Œ VÃ©rifier l'authentification
check-auth:
	@echo "ğŸ”¹ VÃ©rification de l'authentification..."
	gcloud auth list

# ğŸ“Œ Lister les buckets du projet
list-buckets:
	@echo "ğŸ”¹ Listing des buckets sur GCP..."
	gcloud storage buckets list

# ğŸ“Œ Supprimer le Service Account (âš ï¸ Attention !)
delete-service-account:
	@echo "âš ï¸ Suppression du Service Account: $(SERVICE_ACCOUNT_NAME)..."
	gcloud iam service-accounts delete $(SERVICE_ACCOUNT_EMAIL) --quiet

# ğŸ“Œ Supprimer la clÃ© dâ€™authentification
delete-key:
	@echo "âš ï¸ Suppression de la clÃ© JSON..."
	rm -f $(SERVICE_ACCOUNT_KEY)

# ğŸ“Œ Commande pour tout configurer d'un coup
setup-service-account: create-service-account assign-roles generate-key auth-service-account check-auth list-buckets









# ğŸ“Œ 1ï¸âƒ£ Connexion au projet GCP
login:
	gcloud auth application-default login

set-project:
	gcloud config set project $(PROJECT_ID)


connect_project: login set-project


auth-check:
	gcloud auth list

# ğŸ“Œ 2ï¸âƒ£ VÃ©rifier les buckets existants
list-buckets:
	gcloud storage buckets list

# ğŸ“Œ 3ï¸âƒ£ Gestion des donnÃ©es et modÃ¨les
upload-data:
	gcloud storage cp -r ./data gs://$(DATA_BUCKET)/

download-data:
	gcloud storage cp -r gs://$(DATA_BUCKET)/* ./data/

upload-models:
	gcloud storage cp -r ./backend/models gs://$(MODELS_BUCKET)/

download-models:
	gcloud storage cp -r gs://$(MODELS_BUCKET)/* ./backend/models/

# ğŸ“Œ 4ï¸âƒ£ Lancer l'application avec Docker
run:
	docker build -t parcoursur-app .
	docker run -p 8000:8000 -p 3000:3000 parcoursur-app

# ğŸ“Œ 5ï¸âƒ£ DÃ©ploiement sur Cloud Run
deploy:
	docker build -t gcr.io/$(PROJECT_ID)/parcoursur-app .
	docker push gcr.io/$(PROJECT_ID)/parcoursur-app
	gcloud run deploy parcoursur-app \
		--image gcr.io/$(PROJECT_ID)/parcoursur-app \
		--platform managed \
		--region us-central1 \
		--allow-unauthenticated



run:
	docker-compose up --build

upload-data:
	python infrastructure/upload_to_gcs.py

download-models:
	python infrastructure/download_from_gcs.py


